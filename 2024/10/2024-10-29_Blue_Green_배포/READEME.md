# ECS Blue/Green 배포

내가 작업했던 스킬들을 잊지 않고 기억하고자 기록으로 남기려고 한다. 오늘은 최근 작업했던 스킬들 중 **ECS**를 활용해 **Blue/Green 배포**를 진행한 것을 주요 단계와 개념을 잊지 않기 위해 기록을 남긴다. Blue/Green 배포는 운영 환경의 안정성을 유지하면서 새 버전을 배포할 수 있는 효과적인 방법이다.

## 1. Blue/Green 배포 방식 개요
Blue/Green 배포는 현재 운영 중인 버전(Blue)과 새 버전(Green)을 별도의 환경에서 운영하여, 배포 중에도 사용자가 끊김 없이 서비스를 사용할 수 있도록 하는 방식이다. 새로운 버전의 안정성을 Green 환경에서 검증한 후, 트래픽을 전환하여 운영 환경을 안전하게 교체할 수 있다.

## 2. ECS에서의 Blue/Green 배포 작업 과정

- **Docker 이미지 생성**  
  ECS에서 Blue/Green 배포를 진행하기 위해 먼저 애플리케이션을 Docker 이미지로 빌드했다. 새 버전의 기능이 추가되면 코드 변경 사항을 반영한 후, 이를 Docker 이미지로 빌드하여 ECR(Amazon Elastic Container Registry)에 푸시했다.

- **CI/CD 파이프라인 구축**  
  **GitHub Actions**를 활용하여 CI/CD 파이프라인을 설정했다. 코드가 GitHub에 푸시되면 GitHub Actions가 자동으로 Docker 이미지를 빌드하고, ECR에 푸시한 후 ECS에 배포하는 워크플로우를 구성했다. 이를 통해 배포 과정을 자동화하고, 코드 변경 시마다 최신 버전이 자동으로 배포되도록 했다.

- **새 환경(Green) 준비**  
  현재 운영 중인 Blue 환경과 동일한 설정을 가진 Green 환경을 생성하고, ECR에 저장된 최신 Docker 이미지를 Green 환경에 배포했다. 이를 통해 운영 중인 Blue 환경을 유지하면서 Green 환경에서 신규 버전을 테스트할 수 있었다.

- **로드 밸런서 설정**  
  **Application Load Balancer(ALB)**를 사용하여 트래픽을 Blue에서 Green으로 전환하도록 구성했다. ALB를 통해 각 환경으로 트래픽을 분산하고, 필요 시 트래픽을 다시 Blue로 전환할 수 있어 안정성이 높아진다.

- **테스트 및 검증**  
  Green 환경에 새 버전이 정상적으로 작동하는지 테스트했다. 특히 AWS의 **ECS 배포 모드**에서 제공하는 헬스 체크와 로드 밸런서 모니터링을 활용하여 애플리케이션의 성능과 안정성을 검증했다.  
  또한, **Spring Actuator**를 통해 애플리케이션의 상태와 헬스 체크 정보를 확인할 수 있었다. Spring Actuator는 애플리케이션의 상태, 메모리 사용량, CPU 부하 등의 상태를 제공하여, 배포 시점에서 추가적인 검증이 가능하게 했다. 이를 통해 애플리케이션이 예상대로 동작하는지 더욱 정확히 확인할 수 있었다.

## 3. 트러블슈팅: 마이크로서비스 간 Dependency 문제

배포 과정에서 마이크로서비스 간의 Dependency로 인해 문제가 발생했다. 각 서비스는 독립적으로 배포되지만, 특정 마이크로서비스의 변경 사항이 다른 서비스에 영향을 미치면서 의존성 문제가 발생한 것이다.

- **문제 원인**  
  새 버전의 Green 환경에서 일부 마이크로서비스가 서로의 API 버전 차이로 인해 요청을 처리하지 못하는 상황이 발생했다. 예를 들어, 서비스 A는 최신 버전의 API를 사용하고 있지만, 서비스 B는 이전 버전을 호출하고 있어 호환성 문제가 생긴 것이다.

- **해결 과정**  
  1. **버전 관리 및 호환성 테스트**: 마이크로서비스 간 API 버전이 호환되지 않으면 문제가 발생할 수 있으므로, 배포 전에 각 서비스의 버전 호환성을 확인했다.
  2. **의존성 매트릭스 작성**: 각 마이크로서비스가 서로 어떤 버전에서 호환되는지 명시한 의존성 매트릭스를 작성하고, 이를 배포 전 자동 테스트에 포함시켰다.
  3. **CI/CD 파이프라인에 통합 테스트 추가**: GitHub Actions 파이프라인에 통합 테스트 단계를 추가하여, 서로 의존 관계에 있는 서비스가 정상적으로 상호작용하는지 자동으로 검증할 수 있도록 했다.
  4. **Spring Actuator 기반 헬스 체크 강화**: Spring Actuator를 통해 마이크로서비스의 상태와 상호 의존성을 모니터링하여, 트래픽 전환 전 문제가 발생하는 서비스를 빠르게 식별하고 수정할 수 있게 했다.

- **결과**  
  Dependency 문제를 해결한 후, 모든 마이크로서비스가 상호 호환성을 유지한 상태에서 안정적으로 작동했다. 추가적으로, 의존성 매트릭스를 통해 마이크로서비스 변경이 다른 서비스에 미치는 영향을 사전에 파악할 수 있게 되었다.

## 4. Blue/Green 배포의 장점

- **무중단 배포**  
  배포 중에도 사용자에게 영향을 주지 않고 애플리케이션을 업데이트할 수 있어 서비스 가용성을 높일 수 있다.
  
- **빠른 롤백 가능성**  
  만약 Green 환경에서 문제가 발생할 경우, ALB 설정을 통해 즉시 Blue 환경으로 롤백할 수 있다. 이를 통해 배포 실패로 인한 다운타임을 최소화할 수 있다.

- **안정적인 테스트 환경 제공**  
  운영 환경과 동일한 설정으로 Green 환경에서 테스트할 수 있어, 운영 중인 Blue 환경에 영향을 주지 않고 배포 전 모든 검증을 완료할 수 있다.

## 결론
ECS에서의 Blue/Green 배포는 Docker 이미지와 로드 밸런서를 활용하여 대규모 트래픽 상황에서도 안정적으로 새 버전을 배포할 수 있는 강력한 전략이다. 또한, GitHub Actions를 통한 자동화된 CI/CD 파이프라인 구축과 Spring Actuator를 통한 애플리케이션 상태 모니터링으로 배포 과정에서의 추가적인 안정성을 확보할 수 있었다. 특히, 마이크로서비스 간 Dependency 문제를 트러블슈팅하며 배포 전 의존성 매트릭스와 통합 테스트의 중요성을 실감하게 되었다.